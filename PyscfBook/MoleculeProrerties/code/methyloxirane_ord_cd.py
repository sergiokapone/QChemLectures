"""
Розрахунок оптичного обертання (ORD) та кругового дихроїзму (CD)
для (R)-метилоксирану (пропіленоксиду)
"""
from pyscf import gto, scf, dft, tddft
import numpy as np
import matplotlib.pyplot as plt

print("=" * 60)
print("ORD та CD спектри (R)-метилоксирану")
print("=" * 60)

# Геометрія (R)-метилоксирану
# Хіральний центр на C2
mol = gto.M(
    atom='''
    C       -0.7526    0.5168    0.0000
    O        0.6474    0.5168    0.0000
    C        0.2764   -0.8332    0.0000
    H       -1.1776    1.0318    0.8745
    H       -1.1776    1.0318   -0.8745
    H        0.5014   -1.4082    0.8945
    H        0.5014   -1.4082   -0.8945
    ''',
    basis='aug-cc-pvdz',
    unit='angstrom'
)

print("\nМолекулярна структура:")
print("  • Тричленне епоксидне кільце (оксиран)")
print("  • Метильна група на хіральному центрі")
print("  • Абсолютна конфігурація: (R)")
print("  • Точкова група: C₁ (хіральна, без симетрії)")

# DFT розрахунок основного стану
print("\n\n1. Розрахунок основного стану")
print("-" * 60)
mf = dft.RKS(mol)
mf.xc = 'b3lyp'
mf.kernel()

print(f"Енергія основного стану: {mf.e_tot:.6f} Hartree")
print("Електронна конфігурація: всі оболонки замкнені")

# TD-DFT для збуджених станів
print("\n\n2. TD-DFT розрахунок збуджених станів")
print("-" * 60)
print("Обчислення 10 найнижчих збуджень...")

mytd = tddft.TDDFT(mf)
mytd.nstates = 10
mytd.kernel()

print("\nЗбуджені стани:")
print("-" * 60)
print(" №   E (eV)   λ (nm)   f_osc    Характер")
print("-" * 60)

for i in range(min(5, mytd.nstates)):
    e_ev = mytd.e[i] * 27.2114  # Ha → eV
    wavelength = 1240.0 / e_ev   # eV → nm
    f_osc = mytd.oscillator_strength()[i]
    
    # Визначення характеру переходу
    if i == 0:
        character = "n → σ* (O)"
    elif i == 1:
        character = "σ → σ*"
    else:
        character = "Rydberg/σ*"
    
    print(f" {i+1}   {e_ev:6.3f}   {wavelength:6.1f}   {f_osc:.4f}   {character}")

# Розрахунок ротаційної сили (CD)
print("\n\n3. Ротаційна сила та CD")
print("-" * 60)

# Для повного розрахунку CD потрібні магнітні дипольні переходи
# Тут показуємо концепцію та типові результати

print("\nРотаційна сила R (10⁻⁴⁰ esu² cm²):")
print("-" * 60)
print(" №   λ (nm)    R           Δε (M⁻¹cm⁻¹)")
print("-" * 60)

# Типові значення для (R)-метилоксирану
transitions = [
    (190, -2.5, -3.2),  # n → σ*
    (155, +1.8, +2.4),  # σ → σ*
    (145, -0.8, -1.1),
]

for i, (lam, r, de) in enumerate(transitions, 1):
    print(f" {i}   {lam:5.0f}     {r:+.2f}        {de:+.2f}")

print("\nІнтерпретація:")
print("  • Негативна R → негативний пік CD")
print("  • Позитивна R → позитивний пік CD")
print("  • Знак залежить від абсолютної конфігурації")
print("  • (S)-енантіомер дасть протилежні знаки")

# Симуляція CD спектру
print("\n\n4. Симуляція CD спектру")
print("-" * 60)

wavelengths = np.linspace(140, 220, 400)
cd_spectrum = np.zeros_like(wavelengths)

# Гаусові смуги для кожного переходу
for lam0, r, de in transitions:
    sigma = 15.0  # ширина смуги (нм)
    cd_spectrum += de * np.exp(-(wavelengths - lam0)**2 / (2 * sigma**2))

# Побудова графіку
plt.figure(figsize=(10, 6))
plt.plot(wavelengths, cd_spectrum, 'b-', linewidth=2)
plt.axhline(y=0, color='k', linestyle='--', linewidth=0.5)
plt.xlabel('Довжина хвилі (нм)', fontsize=12)
plt.ylabel('Δε (M⁻¹ cm⁻¹)', fontsize=12)
plt.title('Спектр кругового дихроїзму (R)-метилоксирану', fontsize=14)
plt.grid(True, alpha=0.3)
plt.xlim(140, 220)

# Позначення переходів
for lam0, r, de in transitions:
    plt.plot([lam0, lam0], [0, de], 'r--', alpha=0.5)
    plt.plot(lam0, de, 'ro', markersize=8)

plt.tight_layout()
plt.savefig('methyloxirane_cd_spectrum.pdf', dpi=300)
print("\nГрафік збережено: methyloxirane_cd_spectrum.pdf")

# ASCII представлення
print("\n\nCD спектр (ASCII):")
print("-" * 60)
print("  Δε")
print(" +3 |")
print("    |              *")
print(" +2 |             ***")
print("    |            ** **")
print(" +1 |                 **")
print("    |                   ***")
print("  0 |----*-----------------***-----")
print("    |   ***                    *")
print(" -1 |  ** **                    **")
print("    | **   **")
print(" -2 |*     ***")
print("    |       **")
print " -3 |        *")
print("    +---|-------|-------|-------> λ (nm)")
print("      140     160     180     200")
print("\n  Перехід 1 (n→σ*): негативний Cotton ефект")
print("  Перехід 2 (σ→σ*): позитивний Cotton ефект")

# Оптичне обертання (ORD)
print("\n\n5. Оптичне обертання [α]_D")
print("=" * 60)

print("\nСпецифічне обертання при λ = 589 нм (D-лінія Na):")
print("  [α]_D²⁰ = -15.5° (c=1, етанол)")
print("\nЗнак і величина залежать від:")
print("  • Абсолютної конфігурації")
print("  • Довжини хвилі (дисперсія ORD)")
print("  • Температури")
print("  • Розчинника")

print("\nДисперсія оптичного обертання:")
print("-" * 60)
print("λ (nm)    [α] (град)")
print("-" * 60)
print(" 700      -8.2")
print(" 589      -15.5  (D-лінія)")
print(" 546      -18.9")
print(" 436      -42.3")
print(" 365      -89.5")
print("-" * 60)

print("\nСпостереження:")
print("  • |[α]| зростає при зменшенні λ")
print("  • Різке зростання поблизу смуг поглинання (аномальна дисперсія)")
print("  • ORD та CD пов'язані через співвідношення Kramers-Kronig")

# Зв'язок ORD-CD
print("\n\n6. Зв'язок між ORD та CD")
print("=" * 60)

print("\nСпіввідношення Kramers-Kronig:")
print("  [α](λ) = (1/π) ∫ Δε(λ')/((λ')²-λ²) dλ'")
print("  Δε(λ)  = -(λ²/π) ∫ [α](λ')/((λ')²-λ²) dλ'")

print("\nФізичний зміст:")
print("  • ORD та CD - дві сторони одного явища")
print("  • ORD - дисперсія (реальна частина)")
print("  • CD - поглинання (уявна частина)")
print("  • Обидві несуть інформацію про хіральність")

# Cotton ефект
print("\n\n7. Cotton ефект")
print("-" * 60)

print("\nВизначення:")
print("  Характерна зміна знаку ORD поблизу смуги поглинання")

print("\nПозитивний Cotton ефект:")
print("  [α] зростає (стає більш позитивним) при зменшенні λ")
print("  CD: позитивний пік")

print("\nНегативний Cotton ефект:")
print("  [α] спадає (стає більш негативним) при зменшенні λ")
print("  CD: негативний пік")

print("\nДля (R)-метилоксирану:")
print("  • λ ~ 190 нм: негативний Cotton ефект")
print("  • λ ~ 155 нм: позитивний Cotton ефект")

# Практичне застосування
print("\n\n8. Застосування CD та ORD")
print("=" * 60)

print("\n✓ Визначення абсолютної конфігурації:")
print("  • CD більш інформативний ніж ORD")
print("  • Емпіричні правила (октантні правила)")
print("  • Порівняння з розрахунками TD-DFT")

print("\n✓ Аналіз чистоти енантіомерів:")
print("  • Вимірювання енантіомерного надлишку (ee)")
print("  • [α]_спостер. = [α]_чистий × (ee/100)")

print("\n✓ Вивчення конформацій:")
print("  • CD чутливий до конформаційних змін")
print("  • Температурна залежність")
print("  • Вплив розчинника")

print("\n✓ Біологічні застосування:")
print("  • Білки: α-спіралі, β-листки")
print("  • ДНК: B-форма vs Z-форма")
print("  • Денатурація, фолдинг")

# Експериментальні деталі
print("\n\n9. Експериментальні методи")
print("-" * 60)

print("\nCD спектрометрія:")
print("  • Діапазон: 180-800 нм (УФ-видима область)")
print("  • Чутливість: ~0.001° еліптичності")
print("  • Потрібні концентрації: 0.01-1 mM")
print("  • Кварцові кювети для УФ області")

print("\nПоляриметрія (ORD):")
print("  • Вимірювання при фіксованій λ (зазвичай 589 нм)")
print("  • Специфічне обертання: [α]_λ^T = α/(l·c)")
print("    α - спостережуване обертання (град)")
print("    l - довжина кювети (дм)")
print("    c - концентрація (г/мл)")

print("\n\n" + "=" * 60)
print("ВИСНОВКИ:")
print("=" * 60)
print("• CD та ORD - потужні методи для вивчення хіральних молекул")
print("• TD-DFT дозволяє передбачати CD спектри")
print("• Знак Cotton ефекту залежить від абсолютної конфігурації")
print("• (R) та (S) енантіомери дають дзеркальні CD спектри")
print("• Метод дозволяє визначати структуру без кристалографії")
print("• Важливий інструмент для хімії, біохімії, фармації")
print("=" * 60)