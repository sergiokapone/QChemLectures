% !TeX program = lualatex
% !TeX encoding = utf8
% !TeX spellcheck = uk_UA
% !TeX root =../PyscfBook.tex

%=========================================================
\Opensolutionfile{answer}[\currfilebase/\currfilebase-Answers]
\chapter{Властивості молекул}\label{\currfilebase}
%=========================================================


Після обчислень електронної структури молекули природним кроком є
обчислення її спостережуваних властивостей: коливальних спектрів,
оптичних переходів, електричних та магнітних характеристик.
PySCF надає потужні інструменти для розрахунку цих властивостей
на рівні теорії Хартрі-Фока та пост-ХФ методів.


У попередніх розділах ви навчилися виконувати основні квантово-хімічні
розрахунки: оптимізувати геометрію, обчислювати енергії, аналізувати
хвильові функції. Тепер настав час перейти до \textbf{обчислення
молекулярних властивостей} --- фізичних величин, які можна безпосередньо
порівняти з експериментом.

%% --------------------------------------------------------
\subsection*{Що таке молекулярні властивості?}
%% --------------------------------------------------------

\textbf{Молекулярні властивості} --- це спостережувані величини, які
характеризують поведінку молекули у зовнішніх полях або при взаємодії
з випромінюванням. На відміну від енергії чи геометрії, властивості
безпосередньо вимірюються експериментально:

\begin{itemize}
    \item \textbf{Коливальні спектри (ІЧ, Раман):} частоти, інтенсивності.
    \item \textbf{Електронні спектри (УФ-видимі):} довжини хвиль, сили осциляторів.
    \item \textbf{Електричні властивості:} дипольний момент, поляризовність.
    \item \textbf{Магнітні властивості:} ЯМР зсуви, g-тензор, константи спін-спінової взаємодії.
    \item \textbf{Оптична активність:} круговий дихроїзм, оптичне обертання.
\end{itemize}

\textbf{Головна перевага обчислення властивостей:} можна безпосередньо
порівняти теорію з експериментом та перевірити якість обчислень!

%% --------------------------------------------------------
\subsection*{Встановлення додаткових модулів PySCF}
%% --------------------------------------------------------

Базова інсталяція PySCF містить функціонал для розрахунку енергій,
градієнтів та оптимізації геометрії. Для обчислення спектроскопічних
та магнітних властивостей потрібні \textbf{додаткові модулі}.

\subsubsection*{Основні модулі для властивостей}

\begin{enumerate}
    \item \texttt{pyscf-properties} --- головний модуль для властивостей:
    \begin{minted}{bash}
pip install pyscf-properties
    \end{minted}

    Цей модуль включає:
    \begin{itemize}
        \item \texttt{pyscf.prop.nmr} --- ЯМР константи екранування
        \item \texttt{pyscf.prop.esr} --- ЕПР g-тензор, константи надтонкої взаємодії
        \item \texttt{pyscf.prop.polarizability} --- поляризовність, гіперполяризовності
        \item \texttt{pyscf.prop.magnetizability} --- магнітна сприйнятливість
    \end{itemize}

    \item \textbf{pyscf-geomopt} --- для оптимізації геометрії:
    \begin{minted}{bash}
pip install pyscf-geomopt
    \end{minted}

    \item \textbf{geometric} --- покращена оптимізація (рекомендується):
    \begin{minted}{bash}
pip install geometric
    \end{minted}
\end{enumerate}

\subsubsection*{Перевірка встановлення}

Після інсталяції перевірте, чи працюють модулі:

\begin{minted}{python}
import pyscf
from pyscf import gto, scf
from pyscf.prop import nmr, esr  # для магнітних властивостей
from pyscf.hessian import thermo  # для коливальних властивостей
from pyscf import tddft  # для електронних збуджень

print("PySCF версія:", pyscf.__version__)
print("Модулі успішно імпортовані!")
\end{minted}


Якщо імпорт проходить без помилок --- все готово для роботи!

\subsubsection*{Альтернатива: встановлення з conda}

Для користувачів Anaconda/Miniconda:

\begin{minted}{python}
conda install -c pyscf pyscf
conda install -c conda-forge geometric
pip install pyscf-properties  # properties поки немає в conda
\end{minted}

%% --------------------------------------------------------
\subsection*{Концептуальна основа: теорія відгуку}
%% --------------------------------------------------------

Теорія відгуку (response theory) є потужним інструментом для обчислення молекулярних властивостей у квантовій механіці. Її суть полягає в аналізі реакції системи на зовнішні збурення: ми застосовуємо слабке зовнішнє поле (або збурення) і спостерігаємо, як змінюється енергія, хвильова функція чи інші observable величини. Цей підхід дозволяє систематично обчислювати похідні енергії по параметрах збурення, які безпосередньо відповідають фізичним властивостям, таким як поляризовність, магнітні моменти чи спектроскопічні переходи.

Загалом, енергія системи в присутності збурення $\lambda$ (де $\lambda$ може бути будь-яким параметром, наприклад, електричним або магнітним полем чи геометрією молекули тощо) розкладається в ряд Тейлора:

\[
E(\lambda) = E_0 + \left. \frac{\partial E}{\partial \lambda} \right|_{\lambda=0} \lambda + \frac{1}{2!} \left. \frac{\partial^2 E}{\partial \lambda^2} \right|_{\lambda=0} \lambda^2 + \frac{1}{3!} \left. \frac{\partial^3 E}{\partial \lambda^3} \right|_{\lambda=0} \lambda^3 + \ldots
\]

Коефіцієнти при степенях $\lambda$ є похідними енергії по збуренню в точці $\lambda=0$ і визначають лінійний, квадратичний тощо відгук системи. Ці похідні інтерпретуються як фундаментальні властивості:

\begin{itemize}
    \item Перша похідна $\left. \frac{\partial E}{\partial \lambda} \right|_{\lambda=0}$ --- лінійний відгук (наприклад, дипольний момент).
    \item Друга похідна $\left. \frac{\partial^2 E}{\partial \lambda^2} \right|_{\lambda=0}$ --- квадратичний відгук (наприклад, поляризовність).
    \item Вищі похідні --- нелінійні ефекти (гіперполяризовність тощо).
\end{itemize}

\textbf{Загальний принцип:} будь-яка молекулярна властисть, пов'язана з відгуком на збурення, є похідною енергії (або хвильової функції) по відповідному параметру.

\subsubsection*{Приклад: розклад енергії в електричному полі}

Для ілюстрації розглянемо конкретний випадок статичного однорідного електричного поля $\mathbf{E}$. Енергія системи розкладається як:

\[
E(\mathbf{E}) = E_0 - \boldsymbol{\mu} \cdot \mathbf{E}
- \frac{1}{2}\sum_{ij} \alpha_{ij} E_i E_j
- \frac{1}{6}\sum_{ijk} \beta_{ijk} E_i E_j E_k + \ldots
\]

де:
\begin{itemize}
    \item $E_0$ --- енергія системи без поля.
    \item $\boldsymbol{\mu}$ --- статичний дипольний момент (перша похідна $\left. -\frac{\partial E}{\partial \mathbf{E}} \right|_{\mathbf{E}=0}$).
    \item $\alpha_{ij}$ --- тензор поляризовності (друга похідна $\left. -\frac{\partial^2 E}{\partial E_i \partial E_j} \right|_{\mathbf{E}=0}$).
    \item $\beta_{ijk}$ --- тензор першої гіперполяризовності (третя похідна $\left. -\frac{\partial^3 E}{\partial E_i \partial E_j \partial E_k} \right|_{\mathbf{E}=0}$).
\end{itemize}

Цей розклад є частковим випадком загальної теорії відгуку, де $\lambda \equiv \mathbf{E}$. Аналогічно, теорія застосовується до магнітних полів (для магнітної сприйнятливості), геометричних змін (для сил і гессіанів) чи часозалежних збурень (для спектроскопії).

\textbf{Загальний принцип:}
\begin{equation*}
     \text{властивість} = \text{похідна енергії по зовнішньому полю}.
\end{equation*}

\subsubsection*{Методи обчислення похідних}

\begin{enumerate}
    \item \textbf{Числові похідні (finite differences):}
    \[
    \alpha_{xx} = -\frac{\partial^2 E}{\partial E_x^2} \approx
    \frac{E(E_x) + E(-E_x) - 2E(0)}{\Delta E_x^2}
    \]

    \textit{Плюси:} просто, універсально\\
    \textit{Мінуси:} неточно, повільно, багато розрахунків

    \item \textbf{Аналітичні похідні:}
    \[
    \alpha_{ij} = -\left.\frac{\partial^2 E}{\partial E_i \partial E_j}\right|_{E=0}
    = \text{складна формула через хвильову функцію}
    \]

    \textit{Плюси:} точно, швидко, один розрахунок\\
    \textit{Мінуси:} складна реалізація

    \item \textbf{Coupled-Perturbed методи (CP-HF, CP-KS):}

    Розв'язують рівняння для змін орбіталей під дією поля.
    Використовується в PySCF для більшості властивостей.
\end{enumerate}

\textbf{Рекомендація:} завжди використовуйте аналітичні похідні, коли вони доступні!

%% --------------------------------------------------------
\subsection*{Gauge-invariance для магнітних властивостей}
%% --------------------------------------------------------

Магнітні властивості (ЯМР, магнітна сприйнятливість) мають специфічну проблему:
результат залежить від вибору \textbf{gauge} (калібрування) векторного потенціалу.

\subsubsection*{Проблема gauge origin}

Магнітне поле $\mathbf{B}$ можна записати через векторний потенціал:
\[
\mathbf{B} = \nabla \times \mathbf{A}
\]

Але $\mathbf{A}$ не унікальний! Калібрувальне перетворення
$\mathbf{A} \to \mathbf{A} + \nabla\chi$ не змінює $\mathbf{B}$.

Для скінченного базису результат \textbf{залежить від вибору початку координат}
для $\mathbf{A}$ --- це нефізично!

\subsubsection*{Рішення: GIAO (Gauge-Independent Atomic Orbitals)}

У PySCF використовується метод GIAO (також називається IGLO, CSGT):

\begin{itemize}
    \item Кожна атомна орбіталь має своє локальну калібрування.
    \item Результати не залежать від вибору початку координат.
    \item Швидка збіжність з розміром базису.
    \item \textbf{Стандарт} для розрахунків ЯМР властивостей.
\end{itemize}

\textbf{В PySCF це працює автоматично} --- не потрібно нічого додатково налаштовувати!

\begin{minted}{python}
from pyscf.prop import nmr

# GIAO використовується автоматично
nmr_calc = nmr.RHF(mf)
shielding = nmr_calc.kernel()  # gauge-independent результат!
\end{minted}

%% --------------------------------------------------------
\subsection*{Базиси для розрахунку властивостей}
%% --------------------------------------------------------

\textbf{Важливо:} базиси для енергій $\neq$ базиси для властивостей!

\subsubsection*{Загальні вимоги}

\begin{enumerate}
    \item \textbf{Дифузні функції (aug-, d-aug-):}

    Критично важливі для:
    \begin{itemize}
        \item Поляризовностей (опис деформації електронної густини)
        \item Магнітних властивостей (струми далеко від ядер)
        \item Анізотропних властивостейs
    \end{itemize}

    Базиси: \texttt{aug-cc-pVDZ}, \texttt{aug-cc-pVTZ}, \texttt{6-311++G**}

    \item \textbf{Високий angular momentum (поляризаційні функції):}

    Для точних властивостей потрібні $d$, $f$, іноді $g$ функції.

    \item \textbf{Tight functions для ЯМР:}

    ЯМР екранування чутливе до густини \textit{на ядрі} $\rho(\mathbf{R}_A)$.
    Спеціальні базиси: \texttt{pcS-n}, \texttt{pcJ-n}
\end{enumerate}

\subsubsection*{Спеціалізовані базиси}

\begin{center}
\begin{tblr}{lll}
\toprule
Властивість & Рекомендований базис & Коментар \\
\midrule
ІЧ частоти & 6-31G*, 6-311G** & Невеликі базиси OK \\
УФ-видимі спектри & aug-cc-pVDZ/TZ & Дифузні важливі \\
Поляризовність & aug-cc-pVDZ & Обов'язково aug- \\
ЯМР екранування & pcS-2, aug-cc-pVTZ & Tight + diffuse \\
J-константи & pcJ-2, pcJ-3 & Спеціальний базис \\
ЕПР (g-тензор, HFC) & EPR-II, EPR-III & Tight s-функції \\
\bottomrule
\end{tblr}
\end{center}

\subsubsection*{Практичні поради}

\begin{itemize}
    \item Для початку: \texttt{aug-cc-pVDZ} --- універсальний вибір
    \item Для точних результатів: \texttt{aug-cc-pVTZ}
    \item Для великих систем: \texttt{6-311+G(2d,p)} --- компроміс
    \item Для ЯМР: спеціалізовані базиси \texttt{pcS-n} кращі за aug-cc-pVnZ
\end{itemize}

%% --------------------------------------------------------
\subsection*{Структура розділу}
%% --------------------------------------------------------

Розділ організовано за типами властивостей:

\begin{enumerate}
    \item \textbf{Коливальні властивості (Розділ X.1):}
    \begin{itemize}
        \item Гессіан та нормальні моди
        \item ІЧ спектри (інтенсивності, відбір правила)
        \item Раман спектри
        \item Термохімія та ZPE
    \end{itemize}

    \item \textbf{Електронні властивості (Розділ X.2):}
    \begin{itemize}
        \item Електронні збудження (TD-DFT)
        \item УФ-видимі спектри
        \item Флуоресценція та фосфоресценція
    \end{itemize}

    \item \textbf{Електричні властивості (Розділ X.3):}
    \begin{itemize}
        \item Дипольний момент
        \item Поляризовність (статична та динамічна)
        \item Гіперполяризовності
        \item Електростатичний потенціал
    \end{itemize}

    \item \textbf{Магнітні властивості (Розділ X.4):}
    \begin{itemize}
        \item Магнітна сприйнятливість
        \item ЯМР константи екранування та J-константи
        \item ЕПР властивості (g-тензор, HFC)
        \item Оптична активність (ORD, CD)
    \end{itemize}
\end{enumerate}

%% --------------------------------------------------------
\subsection*{Філософія прикладів}
%% --------------------------------------------------------

Кожна підсекція містить:

\begin{itemize}
    \item \textbf{Теоретичне введення:} що ми обчислюємо і чому це важливо
    \item \textbf{Повний робочий код:} готовий до запуску приклад
    \item \textbf{Інтерпретацію результатів:} що означають числа
    \item \textbf{Порівняння з експериментом:} наскільки точна теорія
    \item \textbf{Методологічні поради:} як вибрати метод/базис
\end{itemize}

%\textbf{Важливий принцип:} ми використовуємо \textbf{фізично цікаві} молекули,
%а не просто ``іграшкові'' приклади:
%\begin{itemize}
%    \item \ce{H2O} --- прототип для H-зв'язків
%    \item Бензен --- ароматичність
%    \item \ce{O2}, \ce{NO} --- парамагнетики
%    \item Хіральні молекули --- оптична активність
%\end{itemize}

%% --------------------------------------------------------
\subsection*{Практичні рекомендації перед початком}
%% --------------------------------------------------------

\subsubsection*{Типовий workflow розрахунку властивостей}

\begin{enumerate}
    \item \textbf{Оптимізуйте геометрію:}
    \begin{minted}{python}
from pyscf import gto, scf
from pyscf.geomopt.geometric_solver import optimize

mol = gto.M(atom='...', basis='6-31g*')
mf = scf.RHF(mol).run()
mol_eq = optimize(mf)  # оптимізована геометрія
    \end{minted}

    \item \textbf{Перерахуйте з кращим базисом:}
    \begin{minted}{python}
mol_prop = gto.M(atom=mol_eq.atom, basis='aug-cc-pvdz')
mf_prop = scf.RHF(mol_prop).run()
    \end{minted}

    \item \textbf{Обчисліть властивість:}
    \begin{minted}{python}
from pyscf.prop import nmr
nmr_calc = nmr.RHF(mf_prop)
shielding = nmr_calc.kernel()
    \end{minted}

    \item \textbf{Проаналізуйте результат!}
\end{enumerate}

\subsubsection*{Типові помилки початківців}

\begin{itemize}
    \item Розрахунок властивостей без оптимізації геометрії
    \item Використання малих базисів (6-31G) для поляризовностей
    \item Забування про дифузні функції для анізотропних властивостей
    \item Розрахунок ЯМР без gauge-independent методу
    \item Порівняння абсолютних значень замість зсувів (для ЯМР)
\end{itemize}

\subsubsection*{Контрольний чек-лист}

Перед розрахунком властивості перевірте:

\begin{itemize}
    \item Геометрія оптимізована? (немає уявних частот)
    \item Базис підходить для цієї властивості?
    \item Метод підходить? (HF завищує поляризовність, потрібен DFT/MP2)
    \item Для магнітних: gauge-independent метод?
    \item SCF збігся? (check \inlinecode{mf.converged})
    \item Для радикалів: перевірили $\langle S^2 \rangle$?
\end{itemize}

%% --------------------------------------------------------
\subsection*{Корисні ресурси}
%% --------------------------------------------------------

\begin{itemize}
    \item \textbf{Документація PySCF:} \url{https://pyscf.org/user.html}
    \item \textbf{PySCF properties:} \url{https://github.com/pyscf/properties}
    \item \textbf{Basis Set Exchange:} \url{https://www.basissetexchange.org/}
    \item \textbf{NIST WebBook:} експериментальні дані для порівняння
\end{itemize}


\input{\currfiledir/Oscilations.tex}
%\input{\currfiledir/ElectricProperties.tex}
%\input{\currfiledir/MagneticProperties.tex}
