import numpy as np

def transform_to_normal_coordinates(hessian, normal_modes):
    """
    Перетворює гессіан у нормальні координати.

    :param hessian: numpy.ndarray, матриця Гессе (NxN)
    :param normal_modes: numpy.ndarray, матриця нормальних мод (NxN), стовпці - нормальні координати
    :return: (diagonal_hessian, frequencies_cm1)
    """
    # Преобразуем гессиан: Q^T H Q
    H_diag = normal_modes.T @ hessian @ normal_modes

    # Частоти в атомних одиницях: корінь із діагональних елементів
    omega_squared = np.diag(H_diag)
    omega_au = np.sqrt(np.abs(omega_squared)) * np.sign(omega_squared)  # враховуємо негативні значення

    # Conversion to cm-¹ (1 a.u. of frequency ≈ 5140.48 cm-¹)
    conversion_factor = 5140.48
    frequencies_cm1 = omega_au * conversion_factor

    return H_diag, frequencies_cm1


if __name__ == "__main__":
    # hessian - 6x6 numpy array (with ORCA)
    hessian = np.array([
        [7.0532537229E-01, -1.2607426926E-01, -1.0627111007E-16, -6.1879335195E-01, -3.8266400647E-02, 1.3241970820E-16, -8.6529009176E-02, 1.6434556548E-01, -3.4324381346E-17],
        [-1.2607426926E-01, 6.4006241975E-01, -1.3068006776E-16, 2.6592947682E-02, -5.3901973033E-02, -2.6591949667E-18, 9.9482200205E-02, -5.8616080140E-01, 1.2276907024E-16],
        [-1.0627111007E-16, -1.3068006776E-16, -1.8042517991E-06, 1.1394817735E-16, 1.6534196967E-17, 2.6269563302E-06, -7.6342680186E-18, 1.1415401956E-16, 2.6269241800E-06],
        [-6.1879335195E-01, 2.6592947682E-02, 1.1394817735E-16, 6.3286081404E-01, -1.8967751879E-02, -1.0137075860E-16, -1.4066729452E-02, -7.6341424131E-03, -2.3196805187E-18],
        [-3.8266400647E-02, -5.3901973033E-02, 1.6534196967E-17, -1.8967751879E-02, 5.5116178464E-02, 7.9828642118E-18, 5.7238298272E-02, -1.2208896488E-03, -2.3986115116E-17],
        [1.3241970820E-16, -2.6591949667E-18, 2.6269563302E-06, -1.0137075860E-16, 7.9828642118E-18, -1.1892775283E-05, -3.1073901140E-17, -5.3383866798E-18, 7.5410048511E-06],
        [-8.6529009176E-02, 9.9482200205E-02, -7.6342680186E-18, -1.4066729452E-02, 5.7238298272E-02, -3.1073901140E-17, 1.0059199484E-01, -1.5671644744E-01, 3.6626214148E-17],
        [1.6434556548E-01, -5.8616080140E-01, 1.1415401956E-16, -7.6341424131E-03, -1.2208896488E-03, -5.3383866798E-18, -1.5671644744E-01, 5.8738872995E-01, -9.8776386458E-17],
        [-3.4324381346E-17, 1.2276907024E-16, 2.6269241800E-06, -2.3196805187E-18, -2.3986115116E-17, 7.5410048511E-06, 3.6626214148E-17, -9.8776386458E-17, -1.1892743147E-05]
    ])


    # normal_modes - 6x6 numpy array (from $normal_modes; each column is a mode)
    normal_modes = np.array([
        [0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 4.2952377467E-02, -3.0948375304E-02, -5.5808710051E-02],
        [0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 5.5482741971E-02, -3.9988343829E-02, 4.3198562098E-02],
        [0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00],
        [0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 1.5025866233E-03, 7.0509128275E-01, 7.0540117021E-01],
        [0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, -7.0536235521E-01, -3.8409087435E-02, -3.8340840634E-03],
        [0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00],
        [0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, -6.8324374445E-01, -2.1387793307E-01, 1.8039600450E-01],
        [0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, -1.7526104638E-01, 6.7310503279E-01, -6.8181452210E-01],
        [0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00, 0.0000000000E+00]
    ])

    H_diag, freqs = transform_to_normal_coordinates(hessian, normal_modes)

    print("Діагональний гессиан:")
    print(np.round(H_diag, 6))  # округлення для зручності

    print("Частоти (см⁻¹):")
    print(np.round(freqs, 2))
